const test = require('ava')
const { union, create, fromPoints, toString } = require('./index')

test('geom3: union() should create proper union from empty geometries', (t) => {
  const obj1 = create()
  const obj2 = create()
  const obj3 = create()

  // one empty geometry
  const ret1 = union(obj1)
  const exp1 = { 
    polygons: [],
    isCanonicalized: true,
    isRetesselated: true
  }
  t.deepEqual(ret1, exp1)

  // two empty geometries
  const ret2 = union(obj1, obj2)
  const exp2 = { 
    polygons: [],
    isCanonicalized: true,
    isRetesselated: true
  }
  t.deepEqual(ret2, exp2)

  // three empty geometries
  const ret3 = union(obj1, obj2, obj3)
  const exp3 = { 
    polygons: [],
    isCanonicalized: true,
    isRetesselated: true
  }
  t.deepEqual(ret3, exp3)
})

test('geom3: union() should create proper union from solid geometries', (t) => {
  const box1 = [
                 [ [-5.0, -5.0, -5.0], [-5.0, -5.0, 5.0], [-5.0, 5.0, 5.0], [-5.0, 5.0, -5.0] ],
                 [ [5.0, -5.0, -5.0], [5.0, 5.0, -5.0], [5.0, 5.0, 5.0], [5.0, -5.0, 5.0] ],
                 [ [-5.0, -5.0, -5.0], [5.0, -5.0, -5.0], [5.0, -5.0, 5.0], [-5.0, -5.0, 5.0] ],
                 [ [-5.0, 5.0, -5.0], [-5.0, 5.0, 5.0], [5.0, 5.0, 5.0], [5.0, 5.0, -5.0] ],
                 [ [-5.0, -5.0, -5.0], [-5.0, 5.0, -5.0], [5.0, 5.0, -5.0], [5.0, -5.0, -5.0] ],
                 [ [-5.0, -5.0, 5.0], [5.0, -5.0, 5.0], [5.0, 5.0, 5.0], [-5.0, 5.0, 5.0] ]
               ]

  const box2 = [
                 [ [ 15.0, 15.0, 15.0], [ 15.0, 15.0, 25.0], [ 15.0, 25.0, 25.0], [ 15.0, 25.0, 15.0] ],
                 [ [ 25.0, 15.0, 15.0], [ 25.0, 25.0, 15.0], [ 25.0, 25.0, 25.0], [ 25.0, 15.0, 25.0] ],
                 [ [ 15.0, 15.0, 15.0], [ 25.0, 15.0, 15.0], [ 25.0, 15.0, 25.0], [ 15.0, 15.0, 25.0] ],
                 [ [ 15.0, 25.0, 15.0], [ 15.0, 25.0, 25.0], [ 25.0, 25.0, 25.0], [ 25.0, 25.0, 15.0] ],
                 [ [ 15.0, 15.0, 15.0], [ 15.0, 25.0, 15.0], [ 25.0, 25.0, 15.0], [ 25.0, 15.0, 15.0] ],
                 [ [ 15.0, 15.0, 25.0], [ 25.0, 15.0, 25.0], [ 25.0, 25.0, 25.0], [ 15.0, 25.0, 25.0] ]
               ]

  const box3 = [
                 [ [-5.0, -5.0, 5.0], [-5.0, -5.0, 15.0], [-5.0, 5.0, 15.0], [-5.0, 5.0, 5.0] ],
                 [ [5.0, -5.0, 5.0], [5.0, 5.0, 5.0], [5.0, 5.0, 15.0], [5.0, -5.0, 15.0] ],
                 [ [-5.0, -5.0, 5.0], [5.0, -5.0, 5.0], [5.0, -5.0, 15.0], [-5.0, -5.0, 15.0] ],
                 [ [-5.0, 5.0, 5.0], [-5.0, 5.0, 15.0], [5.0, 5.0, 15.0], [5.0, 5.0, 5.0] ],
                 [ [-5.0, -5.0, 5.0], [-5.0, 5.0, 5.0], [5.0, 5.0, 5.0], [5.0, -5.0, 5.0] ],
                 [ [-5.0, -5.0, 15.0], [5.0, -5.0, 15.0], [5.0, 5.0, 15.0], [-5.0, 5.0, 15.0] ]
               ]

  const box4 = [
                 [ [0.0, 0.0, 0.0], [0.0, 0.0, 10.0], [0.0, 10.0, 10.0], [0.0, 10.0, 0.0] ],
                 [ [10.0, 0.0, 0.0], [10.0, 10.0, 0.0], [10.0, 10.0, 10.0], [10.0, 0.0, 10.0] ],
                 [ [0.0, 0.0, 0.0], [10.0, 0.0, 0.0], [10.0, 0.0, 10.0], [0.0, 0.0, 10.0] ],
                 [ [0.0, 10.0, 0.0], [0.0, 10.0, 10.0], [10.0, 10.0, 10.0], [10.0, 10.0, 0.0] ],
                 [ [0.0, 0.0, 0.0], [0.0, 10.0, 0.0], [10.0, 10.0, 0.0], [10.0, 0.0, 0.0] ],
                 [ [0.0, 0.0, 10.0], [10.0, 0.0, 10.0], [10.0, 10.0, 10.0], [0.0, 10.0, 10.0] ]
               ]

  const obj1 = fromPoints(box1)
  const obj2 = fromPoints(box2)
  const obj3 = fromPoints(box3)
  const obj4 = fromPoints(box4)

  // one solid geometry
  const ret1 = union(obj1)
  const exp1 = fromPoints(box1)
  t.deepEqual(ret1, exp1)

  // two non-overlapping geometries
  const ret2 = union(obj1, obj2)
  const exp2 = fromPoints( box1.concat(box2) )
  t.deepEqual(ret2, exp2)

  // two touching geometries (faces)
  const ret3 = union(obj1, obj3)
  const exp3 = fromPoints(
    [
      [[-5.0, -5.0, -5.0], [-5.0, -5.0, 5.0], [-5.0, 5.0, 5.0], [-5.0, 5.0, -5.0], ], // box2
      [[5.0, -5.0, -5.0], [5.0, 5.0, -5.0], [5.0, 5.0, 5.0], [5.0, -5.0, 5.0], ], // box2
      [[-5.0, -5.0, -5.0], [5.0, -5.0, -5.0], [5.0, -5.0, 5.0], [-5.0, -5.0, 5.0], ], // box2
      [[-5.0, 5.0, -5.0], [-5.0, 5.0, 5.0], [5.0, 5.0, 5.0], [5.0, 5.0, -5.0], ], // box2
      [[-5.0, -5.0, -5.0], [-5.0, 5.0, -5.0], [5.0, 5.0, -5.0], [5.0, -5.0, -5.0], ], // box2
      [[-5.0, -5.0, 5.0], [-5.0, -5.0, 15.0], [-5.0, 5.0, 15.0], [-5.0, 5.0, 5.0], ], // box3
      [[5.0, -5.0, 5.0], [5.0, 5.0, 5.0], [5.0, 5.0, 15.0], [5.0, -5.0, 15.0], ], // box3
      [[-5.0, -5.0, 5.0], [5.0, -5.0, 5.0], [5.0, -5.0, 15.0], [-5.0, -5.0, 15.0], ], // box3
      [[-5.0, 5.0, 5.0], [-5.0, 5.0, 15.0], [5.0, 5.0, 15.0], [5.0, 5.0, 5.0], ], // box3
      [[-5.0, -5.0, 15.0], [5.0, -5.0, 15.0], [5.0, 5.0, 15.0], [-5.0, 5.0, 15.0], ] // box3
    ]
  )
  t.deepEqual(ret3, exp3)

  // two overlapping geometries
  const ret4 = union(obj1, obj4)
  const exp4 = fromPoints( 
    [
      [[-5.0, -5.0, -5.0], [-5.0, -5.0, 5.0], [-5.0, 5.0, 5.0], [-5.0, 5.0, -5.0]],
      [[-5.0, -5.0, -5.0], [5.0, -5.0, -5.0], [5.0, -5.0, 5.0], [-5.0, -5.0, 5.0]],
      [[-5.0, -5.0, -5.0], [-5.0, 5.0, -5.0], [5.0, 5.0, -5.0], [5.0, -5.0, -5.0]],
      [[5.0, -5.0, -5.0], [5.0, 0.0, -5.0], [5.0, 0.0, 5.0], [5.0, -5.0, 5.0]],
      [[-5.0, 5.0, -5.0], [-5.0, 5.0, 5.0], [0.0, 5.0, 5.0], [0.0, 5.0, -5.0]],
      [[-5.0, -5.0, 5.0], [0.0, -5.0, 5.0], [0.0, 5.0, 5.0], [-5.0, 5.0, 5.0]],
      [[5.0, 0.0, -5.0], [5.0, 5.0, -5.0], [5.0, 5.0, 0.0], [5.0, 0.0, 0.0]],
      [[5.0, 5.0, 0.0], [5.0, 5.0, -5.0], [0.0, 5.0, -5.0], [0.0, 5.0, 0.0]],
      [[0.0, -5.0, 5.0], [5.0, -5.0, 5.0], [5.0, 0.0, 5.0], [0.0, 0.0, 5.0]],
      [[10.0, 0.0, 0.0], [10.0, 10.0, 0.0], [10.0, 10.0, 10.0], [10.0, 0.0, 10.0]],
      [[0.0, 10.0, 0.0], [0.0, 10.0, 10.0], [10.0, 10.0, 10.0], [10.0, 10.0, 0.0]],
      [[0.0, 0.0, 10.0], [10.0, 0.0, 10.0], [10.0, 10.0, 10.0], [0.0, 10.0, 10.0]],
      [[0.0, 5.0, 10.0], [0.0, 10.0, 10.0], [0.0, 10.0, 0.0], [0.0, 5.0, 0.0]],
      [[5.0, 0.0, 0.0], [10.0, 0.0, 0.0], [10.0, 0.0, 10.0], [5.0, 0.0, 10.0]],
      [[5.0, 10.0, 0.0], [10.0, 10.0, 0.0], [10.0, 0.0, 0.0], [5.0, 0.0, 0.0]],
      [[0.0, 0.0, 5.0], [0.0, 0.0, 10.0], [0.0, 5.0, 10.0], [0.0, 5.0, 5.0]],
      [[5.0, 0.0, 5.0], [5.0, 0.0, 10.0], [0.0, 0.0, 10.0], [0.0, 0.0, 5.0]],
      [[0.0, 5.0, 0.0], [0.0, 10.0, 0.0], [5.0, 10.0, 0.0], [5.0, 5.0, 0.0]]
    ]
  )


  t.deepEqual(ret4, exp4)
})


